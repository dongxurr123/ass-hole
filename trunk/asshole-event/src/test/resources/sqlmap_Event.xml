<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >

<sqlMap namespace="Event">

	<typeAlias alias="EventDO" type="com.tmall.asshole.event.common.Event" />


	<resultMap id="eventsDOResultMap" class="EventDO">
		<result property="id" column="id" />
		<result property="env" column="env" />
		<result property="identifier" column="identifier" />
		<result property="buyer_id" column="buyer_id" />
		<result property="parent_biz_order_id" column="parent_biz_order_id" />
		<result property="biz_order_id" column="biz_order_id" />
		<result property="content" column="content" />
		<result property="type" column="type" />
		<result property="type_class" column="type_class" />
		<result property="exec_count" column="exec_count" />
		<result property="source" column="source" />
		<result property="event_time" column="event_time" />
		<result property="status" column="status" />
		<result property="workcard_id" column="workcard_id" />
		<result property="hash_num" column="hash_num" />
		<result property="gmt_create" column="gmt_create" />
		<result property="gmt_modify" column="gmt_modify" />
		<result property="memo" column="memo" />
		<result property="execute_machine_ip" column="execute_machine_ip" />
		<result property="execute_machine_hash_range" column="execute_machine_hash_range" />
		<result property="operator" column="operator" />
		
	</resultMap>

    <insert id="insert" parameterClass="EventDO">
	
    INSERT INTO service_events( id, env, identifier, buyer_id, parent_biz_order_id, biz_order_id, 
      content, type, type_class, exec_count, source, event_time, status, workcard_id, 
      hash_num, gmt_create, gmt_modify, memo, execute_machine_ip, execute_machine_hash_range, 
      operator)
     VALUES ( #id#, #env#, #identifier#, #buyer_id#, #parent_biz_order_id#, #biz_order_id#, 
      #content#, #type#, #type_class#, #exec_count#, #source#, #event_time#, #status#, #workcard_id#, 
      #hash_num#,now(), now(), #memo#, #execute_machine_ip#, #execute_machine_hash_range#, 
      #operator#)
    <selectKey keyProperty="id" resultClass="java.lang.Long" >
      SELECT LAST_INSERT_ID() AS value
    </selectKey>
  </insert>
  
  
  <update id="update" parameterClass="EventDO" >
    UPDATE service_events 
   
    <dynamic prepend="SET" >
      <!--
      <isNotNull property="id" prepend="," >
        <![CDATA[  
        id = #id#  
        ]]>  
      </isNotNull>
      -->
      <isNotNull property="env" prepend="," >
        <![CDATA[  
        env = #env#  
        ]]>  
      </isNotNull>
      <isNotNull property="identifier" prepend="," >
        <![CDATA[  
        identifier = #identifier#  
        ]]>  
      </isNotNull>
      <isNotNull property="buyer_id" prepend="," >
        <![CDATA[  
        buyer_id = #buyer_Id#  
        ]]>  
      </isNotNull>
      <isNotNull property="parent_biz_order_id" prepend="," >
        <![CDATA[  
        parent_biz_order_id = #parent_biz_order_id#  
        ]]>  
      </isNotNull>
      <isNotNull property="biz_order_id" prepend="," >
        <![CDATA[  
        biz_order_id = #biz_order_id#  
        ]]>  
      </isNotNull>
      <isNotNull property="content" prepend="," >
        <![CDATA[  
        content = #content#  
        ]]>  
      </isNotNull>
      <isNotNull property="type" prepend="," >
        <![CDATA[  
        type = #type#  
        ]]>  
      </isNotNull>
      <isNotNull property="type_class" prepend="," >
        <![CDATA[  
        type_class = #type_class#  
        ]]>  
      </isNotNull>
      <isNotNull property="exec_count" prepend="," >
        <![CDATA[  
        exec_count = #exec_count#  
        ]]>  
      </isNotNull>
      <isNotNull property="source" prepend="," >
        <![CDATA[  
        source = #source#  
        ]]>  
      </isNotNull>
      <isNotNull property="event_time" prepend="," >
        <![CDATA[  
        event_time = #event_time#  
        ]]>  
      </isNotNull>
      <isNotNull property="status" prepend="," >
        <![CDATA[  
        status = #status#  
        ]]>  
      </isNotNull>
      <isNotNull property="workcard_id" prepend="," >
        <![CDATA[  
        workcard_id = #workcard_id#  
        ]]>  
      </isNotNull>
      <isNotNull property="hash_num" prepend="," >
        <![CDATA[  
        hash_num = #hash_num#  
        ]]>  
      </isNotNull>
      <isNotNull property="gmt_create" prepend="," >
        <![CDATA[  
        gmt_create = #gmt_create#  
        ]]>  
      </isNotNull>
      <isNotNull property="gmt_modify" prepend="," >
        <![CDATA[  
        gmt_modify = #gmt_modify#  
        ]]>  
      </isNotNull>
      <isNotNull property="memo" prepend="," >
        <![CDATA[  
        memo = #memo#  
        ]]>  
      </isNotNull>
      <isNotNull property="execute_machine_ip" prepend="," >
        <![CDATA[  
        execute_machine_ip = #execute_machine_ip#  
        ]]>  
      </isNotNull>
      <isNotNull property="execute_machine_hash_range" prepend="," >
        <![CDATA[  
        execute_machine_hash_range = #execute_machine_hash_range#  
        ]]>  
      </isNotNull>
      <isNotNull property="operator" prepend="," >
        <![CDATA[  
        operator = #operator#  
        ]]>  
      </isNotNull>
    </dynamic>
     WHERE id = #id#  
  </update>

	<select id="queryEvent" resultClass="EventDO">
     SELECT * FROM service_events  
	<dynamic prepend="WHERE">
		<isNotNull prepend="AND" property="status">
	     <![CDATA[
	     	status = #status#
	     ]]>
		</isNotNull>
		<isNotNull prepend="AND" property="start">
         <![CDATA[  
        	hash_num >= #start#  
         ]]>
		</isNotNull>
		<isNotNull prepend="AND" property="end">
         <![CDATA[  
        	hash_num <= #end#  
       	 ]]>
		</isNotNull>
		<isNotNull prepend="AND" property="env">
         <![CDATA[  
        	env = #env#  
        	]]>
		</isNotNull>
		<isNotNull property="count">
        	<![CDATA[
    		order by hash_num 
       		limit #count#
        	]]>
		</isNotNull>
		</dynamic>
	</select>
  
    
   <update id="batchChangeStatus">
 	 <![CDATA[ 
   		 UPDATE service_events set status = #to#, gmt_modify = now()  WHERE status = #from# and hash_num <= 10000
      ]]>
  </update> 
    
    
  <update id="batchChangeStatusByTime">
  <![CDATA[ 
    UPDATE service_events set status = #to#, gmt_modify = now()  WHERE status = #from# and hash_num hash_num <= 10000 and gmt_modify <= #date#
    ]]>
  </update>
  
<!--    
	<select id="findByPrimaryKey" parameterClass="java.lang.Long" >
     SELECT *
   	 <![CDATA[  
     FROM service_events WHERE id = #id#
    ]]>  
  	</select>
-->	


</sqlMap>