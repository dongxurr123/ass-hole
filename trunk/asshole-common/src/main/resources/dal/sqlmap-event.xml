<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >

<sqlMap namespace="Event">
	<typeAlias alias="EventDO" type="com.tmall.asshole.common.Event" />

	<resultMap id="eventsDOResultMap" class="EventDO">
		<result property="id" column="id" />
		<result property="status" column="status" />
		<result property="env" column="env" />
		<result property="process_logs" column="process_logs" />
		<result property="memo" column="memo" />
		<result property="type_class" column="type_class" />
		<result property="context" column="context" />
		<result property="execute_machine_ip" column="execute_machine_ip" />
		<result property="execute_machine_hash_range" column="execute_machine_hash_range" />
		<result property="gmt_create" column="gmt_create" />
		<result property="gmt_modified" column="gmt_modified" />
		<result property="operator" column="operator" />
		<result property="hash_num" column="hash_num" />
		<result property="exec_count" column="exec_count" />
		<result property="process_instance_id" column="process_instance_id" />
		<result property="source" column="source" />
		<result property="process_name" column="process_name" />
		<result property="current_name" column="current_name" />
		<result property="exec_start_time" column="exec_start_time" />
		<result property="is_delay_exec" column="is_delay_exec" />
		<result property="process_number" column="process_number" />
	</resultMap>
	

 	<sql id="query_columns" >
    id,status,env,process_logs,memo,type_class,context,execute_machine_ip,execute_machine_hash_range,gmt_create,gmt_modified,operator,hash_num,exec_count,process_instance_id,source,
		process_name,current_name,exec_start_time,is_delay_exec,process_number   
  	</sql>

	<insert id="insert" parameterClass="EventDO">

		INSERT INTO
		process_events(status,env,process_logs,memo,type_class,context,execute_machine_ip,
		execute_machine_hash_range,gmt_create,gmt_modified,operator,hash_num,exec_count,process_instance_id,source,
		process_name,current_name,exec_start_time,is_delay_exec,process_number)

		VALUES
		(#status#,#env#,#process_logs#,#memo#,#type_class#,#context#,#execute_machine_ip#,
		#execute_machine_hash_range#,now(),now(),#operator#,#hash_num#,#exec_count#,#process_instance_id#,#source#,
		#process_name#,#current_name#,now(),#is_delay_exec#,#process_number#)
		<selectKey keyProperty="id" resultClass="java.lang.Long">
			SELECT
			LAST_INSERT_ID() AS value
		</selectKey>
	</insert>

	<update id="update" parameterClass="EventDO">
		UPDATE process_events
		<dynamic prepend="SET">
		
			<isNotNull property="status" prepend=",">
				<![CDATA[
					status = #status#
				]]>
			</isNotNull>
			
			<isNotNull property="process_logs" prepend=",">
				<![CDATA[
					process_logs = #process_logs#
				]]>
			</isNotNull>
			<isNotNull property="memo" prepend=",">
				<![CDATA[
					memo = #memo#
				]]>
			</isNotNull>
			<isNotNull property="type_class" prepend=",">
				<![CDATA[
					type_class = #type_class#
				]]>
			</isNotNull>
			<isNotNull property="context" prepend=",">
				<![CDATA[
					context = #context#
				]]>
			</isNotNull>
			<isNotNull property="execute_machine_ip" prepend=",">
				<![CDATA[
					execute_machine_ip = #execute_machine_ip#
				]]>
			</isNotNull>
			<isNotNull property="execute_machine_hash_range" prepend=",">
				<![CDATA[
				execute_machine_hash_range = #execute_machine_hash_range#
				]]>
			</isNotNull>
			<isNotNull property="status" prepend=",">
				<![CDATA[
				gmt_modified = now()
				]]>
			</isNotNull>
			<isNotNull property="operator" prepend=",">
				<![CDATA[
				operator = #operator#
				]]>
			</isNotNull>
			<isNotNull property="hash_num" prepend=",">
				<![CDATA[
				hash_num = #hash_num#
				]]>
			</isNotNull>
			<isNotNull property="exec_count" prepend=",">
				<![CDATA[
				exec_count = #exec_count#
				]]>
			</isNotNull>
			<isNotNull property="process_instance_id" prepend=",">
				<![CDATA[
				process_instance_id = #process_instance_id#
				]]>
			</isNotNull>
			<isNotNull property="source" prepend=",">
				<![CDATA[
				source = #source#
				]]>
			</isNotNull>
			<isNotNull property="process_name" prepend=",">
				<![CDATA[
				process_name = #process_name#
				]]>
			</isNotNull>
			<isNotNull property="current_name" prepend=",">
				<![CDATA[
				current_name = #current_name#
				]]>
			</isNotNull>	
			<isNotNull property="exec_start_time" prepend=",">
				<![CDATA[
				exec_start_time = now()
				]]>
			</isNotNull>
			<isNotNull property="is_delay_exec" prepend=",">
				<![CDATA[  
				is_delay_exec = #is_delay_exec#
				]]>
			</isNotNull>				
			<isNotNull property="process_number" prepend=",">
				<![CDATA[
				process_number = #process_number#
				]]>
			</isNotNull>		
		</dynamic>
		WHERE id = #id# 
	</update>

	<update id="batchChangeEventStatus">
  		<![CDATA[ 
    		UPDATE process_events SET  status = #to# where status =#from# AND hash_num<=10000
    	]]>
  	</update>


	<select id="findByPrimaryKey" resultMap="eventsDOResultMap" >
	   SELECT
	   <include refid="query_columns" />
	   <![CDATA[  
	     FROM process_events  WHERE id = #id# AND hash_num =#hash_num#
	   ]]>  
	</select>

      <!-- 开始查询 -->


    <select id="eventQuery" resultMap="eventsDOResultMap" >
	   SELECT
	   <include refid="query_columns" />
	   FROM process_events  WHERE
	   <![CDATA[  
	     hash_num >= #start# AND hash_num<= #end# AND env = #env# AND process_number = #process_number#
	  	 order by gmt_modified asc 
	     limit #count#
	   ]]>  
	 </select>



</sqlMap>
